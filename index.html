<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vue-crud-pouchdb</title>
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <!-- below link to google icons sets cookie with Same-Site set to none which will cause problems in future -->
    <!-- install icons locally? -->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <script src="js/vue.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9.14.2/dist/sweetalert2.all.min.js"></script> -->
    <script src="//cdn.jsdelivr.net/npm/pouchdb@7.1.1/dist/pouchdb.min.js"></script>
  </head>
  <body>
    <div id="app">
      <div class="container-fluid">
        <br />
        <div class="row">
          <div class="col-md-8">
            <table class="table table-bordered table-striped">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Address</th>
                  <th width="130">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="item in items" :key="item._id">
                  <th scope="row">{{ item._id }}</th>
                  <td>{{ item.name }}</td>
                  <td>{{ item.email }}</td>
                  <td>{{ item.city }}</td>
                  <td class="text-center">
                    <button
                      @click="editItem(item)"
                      class="btn btn-warning btn-sm"
                    >
                      <i class="material-icons">create</i>
                    </button>
                    <button
                      @click="deleteItem(item)"
                      class="btn btn-danger btn-sm"
                    >
                      <i class="material-icons">delete</i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="col-md-4">
            <div v-if="submitAlert" class="alert alert-success" role="alert">
              The entry has been saved
            </div>
            <div v-if="updateAlert" class="alert alert-success" role="alert">
              The entry has been updated
            </div>
            <div v-if="deleteAlert" class="alert alert-danger" role="alert">
              The entry has been deleted
            </div>
            <form>
              <div class="form-group">
                <label for="id">ID</label>
                <input
                  type="text"
                  class="form-control"
                  id="id"
                  v-model="input._id"
                  readonly
                />
              </div>
              <div class="form-group">
                <label for="name">Name</label>
                <input
                  type="text"
                  v-model="input.name"
                  class="form-control"
                  id="name"
                />
              </div>
              <div class="form-group">
                <label for="email">E-mail</label>
                <input
                  type="email"
                  v-model="input.email"
                  class="form-control"
                  id="email"
                />
              </div>
              <div class="form-group">
                <label for="city">Address</label>
                <input
                  type="textarea"
                  v-model="input.city"
                  class="form-control"
                  id="city"
                />
              </div>
              <button
                v-if="submitbtn"
                type="submit"
                @click.prevent="submitForm"
                class="btn btn-primary"
              >
                Submit
              </button>
              <button
                v-if="updatebtn"
                type="submit"
                @click.prevent="updateItem(input._id)"
                class="btn btn-warning"
              >
                Update
              </button>
              <button
                type="submit"
                @click.prevent="clearForm"
                class="btn btn-info"
              >
                Clear
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <script>
      // window.localCouch = new PouchDB('vue-crud')
      // window.remoteCouch = 'http://serveradmin:couchdb@127.0.0.1:5984/vue-crud'

      let app = new Vue({
        el: '#app',
        data: {
          items: [],
          input: {
            _id: '',
            name: '',
            email: '',
            city: '',
          },
          submitbtn: true,
          updatebtn: false,
          submitAlert: false,
          updateAlert: false,
          deleteAlert: false,
          localCouch: null,
        },
        mounted() {
          this.localCouch = new PouchDB('vue-crud')
          let remoteCouch = 'http://user:secret@raspberrypi:5984/vue-crud'
          // let remoteCouch = 'http://user@127.0.0.1:5984/vue-crud'
          // let remoteCouch = 'http://serveradmin:couchdb@127.0.0.1:5984/vue-crud'
          this.localCouch
            .sync(remoteCouch, { live: true, retry: true })
            .on('change', (change) => {
              console.log('something changed ', change)
              this.fetch()
            })
            .on('error', (err) => {
              // handle error
              console.log('something went wrong!', err)
            })
          // this.sync()
          this.fetch() // initial fetch
        },
        methods: {
          fetch() {
            this.localCouch
              .allDocs({ include_docs: true })
              .then((response) => {
                let list = []
                for (let row of response.rows) {
                  list.push(row.doc)
                }
                // above is the more modern way of writing for loops
                // for (let i = 0; i < response.rows.length; i++) {
                //   list.push(response.rows[i].doc)
                // }
                this.items = list
              })
              // .then((list) => {
              //   this.todos = list
              //   // .then((response) => {
              //   //   for (let i = 0; i < response.rows.length; i++) {
              //   //     this.items.push(response.rows[i].doc)
              //   //   }
              //   console.log('fetched all items')
              // })
              .catch(console.error)
          },
          submitForm() {
            // this.submitAlert = false
            this.updateAlert = false
            this.deleteAlert = false
            // set id to timestamp
            let d = new Date()
            let id = d.getTime().toString()
            // let id = '5'
            // let id = this.input._id
            let nm = this.input.name
            let em = this.input.email
            let ci = this.input.city
            // pouchDB
            this.localCouch
              .put({
                _id: id,
                name: nm,
                email: em,
                city: ci,
              })
              .then(function (response) {})
              .catch(function (error) {
                console.log(error)
              })
            // update vue array
            this.items.push({ _id: id, name: nm, email: em, city: ci })
            // clean up
            this.clearForm()
            this.submitAlert = true
          },
          clearForm() {
            this.submitbtn = true
            this.updatebtn = false
            this.input._id = ''
            this.input.name = ''
            this.input.email = ''
            this.input.city = ''
          },
          editItem(item) {
            this.submitbtn = false
            this.updatebtn = true
            this.submitAlert = false
            this.updateAlert = false
            this.deleteAlert = false
            this.input._id = item._id
            this.input.name = item.name
            this.input.email = item.email
            this.input.city = item.city
          },
          updateItem(id) {
            this.submitAlert = false
            // this.updateAlert = false
            this.deleteAlert = false
            // find the index of the item where a key matches a value
            let ref = this.items.findIndex((x) => x._id === id)
            // assign is used to merge object with same props (target, source)
            Object.assign(this.items[ref], this.input)
            // Below is the original code which does not work when id's get out of sync
            // let myId = id - 1
            // Object.assign(this.items[myId], this.input)
            // pouchDB
            let nm = this.input.name
            let em = this.input.email
            let ci = this.input.city
            this.localCouch
              .get(id)
              .then(function (doc) {
                return app.localCouch.put({
                  _id: id,
                  _rev: doc._rev,
                  name: nm,
                  email: em,
                  city: ci,
                })
              })
              .then(function (response) {})
              .catch(function (error) {
                console.log(error)
              })
            // clean up
            this.clearForm()
            this.updateAlert = true
          },
          deleteItem(item) {
            this.submitAlert = false
            this.updateAlert = false
            // this.deleteAlert = false
            let del = this.items.indexOf(item)
            this.items.splice(del, 1)
            // pouchDB
            this.localCouch
              .get(item._id)
              .then(function (doc) {
                return app.localCouch.remove(doc)
              })
              .then(function (response) {})
              .catch(function (error) {
                console.log(error)
              })
            // clean up
            this.deleteAlert = true
          },
        },
      })
    </script>
  </body>
</html>
